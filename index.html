<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>出題系統 v1.0</title>
    <!-- Bootstrap 5 + Icons (純前端好排版) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Markdown 轉 HTML -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        :root {
            --muted: #6c757d
        }

        body {
            background: #f8fafc
        }

        .card-soft {
            border: 1px solid #e9eef5;
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(16, 24, 40, .06)
        }

        .option-item {
            cursor: pointer;
            border: 1px solid #e5e7eb;
            border-radius: .6rem;
            padding: .75rem 1rem;
            margin-bottom: .5rem;
            transition: all .15s
        }

        .option-item:hover {
            border-color: #b6beca;
            background: #f9fbfd
        }

        .option-correct {
            border-color: #22c55e;
            background: #effdf3
        }

        .option-wrong {
            border-color: #ef4444;
            background: #fff1f2
        }

        .q-meta {
            font-size: .88rem;
            color: var(--muted)
        }

        .badge-easy {
            background: #e6f4ea;
            color: #137333;
            border: 1px solid #c6e8d1
        }

        details>summary {
            cursor: pointer
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc;
            padding: .5rem 0
        }

        .pointer {
            cursor: pointer
        }

        .small-muted {
            font-size: .875rem;
            color: var(--muted)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
        }

        /* 輪播容器 */
        .feature-carousel {
            --fc-nav-size: 32px;
            /* 箭頭大小 */
            --fc-gutter: 40px;
            /* 每張內容左右安全邊界 */
            position: relative;
        }

        /* Viewport 只負責裁切，不能加 padding */
        .fc-viewport {
            position: relative;
            overflow: hidden;
        }

        /* 軌道與每張 */
        .fc-track {
            display: flex;
            transition: transform 600ms ease-in-out !important;
        }

        .fc-item {
            flex: 0 0 100%;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: .25rem var(--fc-gutter);
            /* ← 改在這裡留內距，就不會漏 */
        }

        /* 箭頭置中 */
        .fc-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: var(--fc-nav-size);
            height: var(--fc-nav-size);
            display: grid;
            place-items: center;
            padding: 0;
            z-index: 2;
        }

        .fc-prev {
            left: 8px;
        }

        .fc-next {
            right: 8px;
        }

        /* 圓點 */
        .fc-dot {
            display: inline-block;
            width: 10px;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, .15);
        }

        .fc-dot.active {
            background: rgba(0, 0, 0, .5);
        }

        .fc-dot.inactive {
            background: rgba(0, 0, 0, .08);
        }

        /* 文字輔助 */
        .clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .date-nowrap {
            white-space: nowrap;
        }

        /* Minimal Modal */
        .fc-modal__backdrop {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;   /* 垂直置中 */
        justify-content: center; /* 水平置中 */
        background: rgba(0,0,0,.5);
        z-index: 2000;
        }

        .fc-modal__panel {
        background: #fff;
        border-radius: .5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,.2);
        width: min(640px, 92vw);
        max-height: 80vh;
        overflow: auto;
        }

        .fc-modal__close {
        position: absolute; top: .5rem; right: .5rem;
        }
        @media (max-width: 576px) {
        .fc-modal__panel { width: 94vw; max-height: 86vh; }
        }

        .note-content table {
            border-collapse: collapse;
            width: 100%;
        }

        .note-content th,
        .note-content td {
            border: 1px solid #dee2e6;
            padding: .5rem;
        }

        .note-content tbody tr:nth-child(odd) {
            background-color: #f8f9fa;
        }

    </style>
</head>

<body x-data="quizApp()" x-init="init()" class="py-4">
    <!-- 輪撥 -->
    <!-- 輪撥 -->
    <div x-data="featureCarousel(featureList, { interval: 4000 })" x-init="init()"
        x-show="items.length > 0 && view==='home'" class="feature-carousel alert alert-info text-center"
        @mouseenter="pause()" @mouseleave="play()" tabindex="0" @keydown.left.prevent="modalOpen ? null : prev()"
        @keydown.right.prevent="modalOpen ? null : next()" @keydown.escape.prevent="modalOpen && closeModal()">
    
        <div class="fc-viewport">
            <button class="fc-nav fc-prev btn btn-sm btn-outline-secondary" @click="modalOpen ? null : prev()"
                aria-label="上一則">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="fc-nav fc-next btn btn-sm btn-outline-secondary" @click="modalOpen ? null : next()"
                aria-label="下一則">
                <i class="bi bi-chevron-right"></i>
            </button>
    
            <div class="fc-track" :style="{ transform: `translateX(-${current * 100}%)` }">
                <template x-for="(f, i) in items" :key="i">
                    <div class="fc-item px-5 pointer" @click="openModal(f, i)">
                        <span class="badge text-bg-light border fw-normal"
                            x-text="(current + 1) + ' / ' + items.length"></span>
    
                        <span class="fw-semibold clamp-1" x-text="f.content" :title="f.content"></span>
    
                        <span class="text-secondary small ms-auto date-nowrap">
                            <i class="bi bi-calendar3 me-1"></i>
                            <time x-text="f.date.slice(5).replace('-', '/')"></time>
                        </span>
                    </div>
                </template>
            </div>
        </div>
    
        <!-- 底下圓點 -->
        <div class="d-flex justify-content-center gap-2 mt-1">
            <template x-for="(f, i) in items" :key="'dot' + i">
                <button class="fc-dot" :class="current === i ? 'active' : 'inactive'" @click="go(i)"
                    :aria-label="`第 ${i+1} 則`"></button>
            </template>
        </div>

        <!-- Modal：僅顯示「編號」與「內容」 -->
        <div x-show="modalOpen" x-transition.opacity class="fc-modal__backdrop" role="dialog" aria-modal="true"
            aria-labelledby="fcModalTitle" @click.self="closeModal()" @keydown.escape.prevent="closeModal()">
            <div class="fc-modal__panel position-relative p-3" @click.stop tabindex="-1" x-ref="modalPanel">
                <!-- <button type="button" class="btn btn-sm btn-outline-secondary fc-modal__close" @click="closeModal()"
                    aria-label="關閉">✕</button> -->
        
                <div id="fcModalTitle" class="small text-secondary">
                    <span x-text="(modalIndex + 1) + ' / ' + items.length"></span>
                    <span class="fs-6 ms-1" x-text="modalItem?.content"></span>
                </div>
            </div>
        </div>

    </div>

    <div class="container-xxl">

        <!-- 標題列 -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h4 mb-0 pointer" @click="exitQuiz()">首頁<!--出題系統 <span class="small text-secondary"
                    x-text="version"></span>--> <span class="small text-secondary"><!--｜Alpine.js --></span></h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" x-show="noteFeatureOn" @click="openNote()" title="筆記">
                    <i class="bi bi-journal-richtext" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" @click="openQbankPanel()" title="題庫管理">
                    <i class="bi bi-journal-text" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" @click="openRecordPanel();refreshStatsIds();" title="紀錄管理">
                    <i class="bi bi-collection" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" @click="openBugPanel()" title="Bug 回報">
                    <i class="bi bi-bug" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" x-show="photoFeatureOn" @click="openPhotoViewer()" title="相簿">
                    <i class="bi bi-images" aria-hidden="true"></i>
                </button>
                <!-- <button class="btn btn-outline-secondary btn-sm" @click="exitQuiz()" title="回首頁">
                    <i class="bi bi-house" aria-hidden="true"></i>
                </button> -->
                <button class="btn btn-outline-secondary btn-sm" @click="showHelp = !showHelp" title="說明">
                    <i class="bi bi-question-circle" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" @click="closeAllPanels()" title="關閉全部">
                    <i class="bi bi-x-circle" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <!-- 使用說明 -->
        <div class="alert alert-info py-3 position-relative" x-show="showHelp" x-transition>
            <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" @click="showHelp=false"
                title="關閉說明"><i class="bi bi-x"></i></button>
            <div class="fw-bold mb-1">快速使用：</div>
            <ol class="mb-2">
                <li>用「載入題庫」選擇 <span class="mono">question.json</span>（題庫格式見下方備註）。</li>
                <li>設定出題數、模式與版面（單題/整頁），按「開始測驗」。</li>
                <li>作答後可勾選「這題很簡單不用再出」（答對才生效）或「這題我不確定」做紀錄。</li>
                <li>紀錄會存到瀏覽器 LocalStorage。可隨時「匯出/匯入」同步到另一台電腦。</li>
            </ol>
            <div class="small text-secondary">備註：本系統支援單選/複選（<span class="mono">answer</span> 為陣列，長度 &gt; 1
                視為複選）。<br>解析欄位可放 HTML，建議使用 <span
                    class="mono">&lt;details&gt;&lt;summary&gt;答案與解析&lt;/summary&gt;...&lt;/details&gt;</span> 結構。</div>
        </div>

        <!-- news -->
        <!-- <div class="card card-soft mb-4" x-show="view==='home'">
            <div class="card-body">
                <h2 class="h6">新功能！</h2>
                <div class="row text-center mt-2 justify-content-center g-3">

                </div>
            </div>
        </div> -->

        <!-- 筆記頁面 -->
        <div class="card card-soft mb-4" x-show="view==='note'">
            <div class="card-body">
                <div class="note-content" x-html="noteHtml"></div>
            </div>
        </div>

        <!-- 統計摘要 -->
        <div class="card card-soft mb-4" x-show="view==='home'">
            <div class="card-body">
                <h2 class="h6">題庫統計摘要</h2>
                <div class="row text-center mt-2 justify-content-center g-3">
                    <div class="col-6 col-md-3">
                        <div class="small-muted">總題數</div>
                        <div class="h5" x-text="overallStats.total"></div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small-muted">未作答 | 未標簡單</div>
                        <div class="h5">
                            <span class="text-warning" x-text="overallStats.unanswered"></span> | <span
                                class="text-info" x-text="overallStats.notEasy"></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small-muted">答錯/作答</div>
                        <div class="h5">
                            <span class="text-danger" x-text="overallStats.wrong"></span>/
                            <span x-text="overallStats.totalAttempts"></span>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small-muted">正確率</div>
                        <div class="h5 text-success" x-text="overallStats.accuracy + '%' "></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 載入/設定 卡片 -->
        <div class="card card-soft mb-4" x-show="view==='home'">
            <div class="card-body">
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-12 col-md-3">
                        <label class="form-label">出題數</label>
                        <!-- <span class="small text-secondary mt-1">（題庫目前：<strong x-text="questions.length"></strong>
                            題）</span> -->
                        <div class="input-group">
                            <input type="number" class="form-control" min="1" :max="questions.length||1"
                                x-model.number="numQuestions" />
                            <select class="form-select" @change="numQuestions = Number($event.target.value)">
                                <option value="">選擇</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">版面</label>
                        <select class="form-select" x-model="pageMode">
                            <option value="all">一頁所有題</option>
                            <option value="one">一頁一題</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">其他選項</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shuffle" x-model="shuffle">
                            <label class="form-check-label" for="shuffle">隨機出題</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeEasy" x-model="excludeEasy">
                            <label class="form-check-label" for="excludeEasy">忽略<!-- 已標「 -->簡單<!-- 」的題目 --></label>
                        </div>
                        <div class="form-check" x-show="easyFeatureOn">
                            <input class="form-check-input" type="checkbox" id="excludeDevEasy"
                                x-model="excludeDevEasy">
                            <label class="form-check-label" for="excludeDevEasy">排除開發者標記簡單的題目</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showExpWrong" x-model="expandWrong">
                            <label class="form-check-label" for="showExpWrong">答錯自動展開解析</label>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" :disabled="questions.length===0"
                                @click="startQuiz('normal')"><i class="bi bi-play-circle" aria-hidden="true"></i>
                                開始測驗</button>
                            <button class="btn btn-outline-warning" :disabled="questions.length===0" x-show="overallStats.unanswered > 0"
                                @click="startQuiz('unansweredOnly')"><i class="bi bi-patch-question"
                                    aria-hidden="true"></i> 只出未作答題</button>
                            <button class="btn btn-outline-primary" :disabled="questions.length===0"
                                @click="startQuiz('review')"><i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                                錯題複習（優先）</button>
                            <button class="btn btn-outline-danger" :disabled="questions.length===0"
                                @click="startQuiz('wrongOnly')"><i class="bi bi-exclamation-octagon"
                                    aria-hidden="true"></i>
                                只出錯題</button>
                            <button class="btn btn-outline-success" x-show="overallStats.notEasy > 0"
                                :disabled="questions.length===0 || noWrongNotEasyCount===0"
                                @click="startQuiz('noWrongNotEasy')"
                                :title="`共有${noWrongNotEasyCount}題`"><i class="bi bi-check-circle"
                                    aria-hidden="true"></i> 未標簡單且未答錯題</button>
                        </div>
                    </div>
                </div>

                <hr class="my-4" />
                <!-- 開關折疊的按鈕（右上角已有功能，先隱藏） -->
                <!--
                <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse"
                    data-bs-target="#qbankPanel" aria-expanded="false" aria-controls="#qbankPanel">
                    題庫與紀錄管理
                </button>
                -->

                <!-- 可折疊的內容 -->
                <div class="collapse position-relative" id="qbankPanel">
                    <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2"
                        @click="openQbankPanel()" title="關閉題庫管理"><i class="bi bi-x"></i></button>
                    <div class="row g-3">
                        <div class="col-12 col-lg-6">
                            <div class="mb-2 fw-semibold">載入題庫（question.json）</div>
                            <input type="file" class="form-control" accept=".json,application/json"
                                @change="loadQuestionsFromFile($event)" />
                            <div class="small text-secondary mt-2" x-show="questions.length===0">
                                尚未載入題庫<!-- ，可先載入下方「範例題庫」試用。 -->
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <!--
                                <button class="btn btn-sm btn-outline-secondary" @click="loadQuestionsFromDrive()">
                                    <i class="bi bi-cloud-arrow-down"></i> 雲端硬碟
                                </button>
                                -->
                                <!-- <button class="btn btn-sm btn-outline-primary" @click="loadSample()">
                                    <i class="bi bi-lightning-charge" aria-hidden="true"></i> 載入範例
                                </button> -->
                                <button class="btn btn-sm btn-outline-secondary" @click="loadProjectQuestions()">
                                    <i class="bi bi-file-earmark" aria-hidden="true"></i> 載入專案
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" :disabled="questions.length===0"
                                    @click="downloadQuestions()">
                                    <i class="bi bi-download" aria-hidden="true"></i> 下載
                                </button>
                            </div>
                        </div>

                        <div class="col-12 col-lg-6">
                            <div class="mb-2 fw-semibold">統計紀錄（第二個 JSON，純前端保存在瀏覽器）</div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-success" :disabled="Object.keys(stats).length===0"
                                    @click="saveStatsFile()">
                                    <i class="bi bi-save2" aria-hidden="true"></i> 儲存
                                </button>
                                <!-- <button class="btn btn-sm btn-outline-secondary" @click="loadStatsFromFile()">
                                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> 載入
                                </button> -->
                                <label class="btn btn-sm btn-outline-primary mb-0">
                                    <i class="bi bi-upload" aria-hidden="true"></i> 匯入
                                    <input type="file" class="d-none" accept=".json,application/json"
                                        @change="importStatsFile($event)" />
                                </label>
                                <!--
                                <button class="btn btn-sm btn-outline-secondary" @click="importStatsFromDrive()">
                                    <i class="bi bi-cloud-arrow-down"></i> 雲端
                                </button>
                                -->
                                <button class="btn btn-sm btn-outline-danger" @click="clearAllStats()">
                                    <i class="bi bi-trash3" aria-hidden="true"></i> 清空
                                </button>
                            </div>
                            <!-- <div class="small-muted mt-2">統計欄位：出題次數、錯誤次數、最後作答選項、是否標記「簡單」…等。</div> -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 測驗區：一頁一題 -->
        <template x-if="view==='quiz' && pageMode==='one'">
            <div class="card card-soft">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between sticky-header">
                        <div class="small-muted"><!-- 模式：--><span x-text="modeLabel"></span> ｜ <!-- 進度：--><strong
                                x-text="quizSet.length ? currentIndex + 1 : 0"></strong>/<span
                                x-text="quizSet.length"></span> ｜ <!-- 時間：--><strong x-text="timeText"></strong></div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" x-show="!timerPaused" @click="pauseTimer()"
                                title="暫停"><i class="bi bi-pause"></i><!-- 暫停 --></button>
                            <button class="btn btn-sm btn-outline-secondary" x-show="timerPaused" @click="resumeTimer()"
                                title="繼續"><i class="bi bi-play"></i><!-- 繼續 --></button>
                            <button class="btn btn-sm btn-outline-secondary" @click="exitQuiz()" title="回到首頁"><i
                                    class="bi bi-house"></i></button>
                        </div>
                    </div>

                    <template x-if="quizSet.length===0">
                        <div class="alert alert-warning mt-3">此模式下沒有可出題目（可能沒有錯題或全部被標記為簡單）。</div>
                    </template>

                    <template x-if="quizSet.length>0">
                        <div class="mt-3" x-data="questionVM()" x-init="qInit()"
                            @submit-one.window="onSubmitFromParent($event)">
                            <div class="d-flex align-items-start justify-content-between">
                                <div>
                                    <div class="q-meta">題號：<span class="mono" x-text="q.id"></span> ｜ <span
                                            x-text="$root.quizSet.length ? $root.currentIndex + 1 : 0"></span>/<span
                                            x-text="$root.quizSet.length"></span></div>
                                    <div class="fs-5 mt-1" x-html="md(q?.question || '')"></div>
                                </div>
                                <div class="text-end d-flex flex-column align-items-end">
                                    <button class="btn btn-sm btn-outline-secondary mb-2"
                                        @click="Alpine.$data($root).copyQuestion(q)" title="複製">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger mb-2"
                                        @click="Alpine.$data($root).openBug(q.id)" title="Bug 回報">
                                        <i class="bi bi-bug"></i>
                                    </button>
                                    <span class="badge rounded-pill mb-1" :class="(stat?.easy)?'badge-easy':''"
                                        x-text="(stat?.easy)?'已標簡單':''"></span>
                                    <template x-if="(stat?.wrong||0)+(stat?.attempts||0)>0">
                                        <div class="small-muted"><span class="text-danger">錯題</span>/作答：<span
                                                class="text-danger" x-text="stat?.wrong||0"></span>/<span
                                                x-text="stat?.attempts||0"></span></div>
                                    </template>
                                </div>
                            </div>

                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" :id="'unsure_'+q.id"
                                    x-model="markUnsure">
                                <label class="form-check-label" :for="'unsure_'+q.id">這題我不確定</label>
                            </div>

                            <div class="mt-3">
                                <template x-for="opt in q.options" :key="opt.id">
                                    <label class="option-item d-flex gap-2 align-items-start"
                                        :class="optionClass(opt.id)">
                                        <input :type="isMulti? 'checkbox':'radio'" class="form-check-input mt-1"
                                            :name="'opt_'+q.id" :value="opt.id" @change="toggle(opt.id,$event)"
                                            :checked="selected.has(opt.id)" />
                                        <div>
                                            <div class="fw-semibold" x-text="opt.text"></div>
                                            <div class="small text-secondary" x-show="debugMode">id: <span class="mono"
                                                    x-text="opt.id"></span></div>
                                        </div>
                                    </label>
                                </template>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-3 mt-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" :id="'easy_'+q.id"
                                        x-model="markEasy">
                                    <label class="form-check-label" :for="'easy_'+q.id">這題很簡單不用再出（<span
                                            class="text-secondary">需答對才算</span>）</label>
                                </div>
                                <button class="btn btn-outline-secondary" @click="resetCurrent()"><i
                                        class="bi bi-arrow-counterclockwise" aria-hidden="true"></i> 重新作答</button>
                            </div>

                            <!-- 回饋與解析 -->
                            <div class="mt-3" x-show="hasResult">
                                <div class="alert" :class="isCorrect? 'alert-success':'alert-danger'">
                                    <div class="fw-semibold" x-text="isCorrect? '答對了！':'答錯囉～'"></div>
                                    <div class="small mt-1">正確答案：
                                        <span class="mono" x-text="q.answer.join(', ')"></span>
                                    </div>
                                </div>
                                <details class="mt-2" :open="(!isCorrect && $root.expandWrong) || expOpen">
                                    <summary class="fw-semibold pointer" @click.prevent="expOpen = !expOpen"><i
                                            class="bi bi-journal-text"></i> 答案與解析</summary>
                                    <div class="mt-2" x-html="md(q.explanation)"></div>
                                </details>
                            </div>
                        </div>
                    </template>

                    <div class="d-flex justify-content-between mt-4" x-show="quizSet.length>0">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" :disabled="currentIndex===0" @click="prev()"><i
                                    class="bi bi-chevron-left"></i> 上一題</button>
                            <button class="btn btn-outline-secondary" :disabled="currentIndex>=quizSet.length-1"
                                @click="next()">下一題 <i class="bi bi-chevron-right"></i></button>
                        </div>
                        <button class="btn btn-success" @click="finishAndSummary()"><i class="bi bi-flag"></i>
                            結束並看成績</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 測驗區：一頁所有題 -->
        <template x-if="view==='quiz' && pageMode==='all'">
            <div class="card card-soft">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between sticky-header">
                        <div class="small-muted"><!-- 模式：--><span x-text="modeLabel"></span> ｜ <!-- 題數：--><strong
                                x-text="quizSet.length"></strong> ｜ <!-- 時間：--><strong x-text="timeText"></strong></div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" x-show="!timerPaused" @click="pauseTimer()"
                                title="暫停"><i class="bi bi-pause"></i><!-- 暫停 --></button>
                            <button class="btn btn-sm btn-outline-secondary" x-show="timerPaused" @click="resumeTimer()"
                                title="繼續"><i class="bi bi-play"></i><!-- 繼續 --></button>
                            <button class="btn btn-sm btn-outline-secondary" @click="exitQuiz()" title="回到首頁"><i
                                    class="bi bi-house"></i> </button>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3" x-show="showScore" x-transition>
                        <div>成績：<strong x-text="summary.correct"></strong>/<span x-text="summary.total"></span></div>
                        <div class="small">答對 <span x-text="summary.correct"></span> 題 ｜ 答錯 <span
                                x-text="summary.wrong"></span> 題 ｜ 未作答 <span x-text="summary.unanswered"></span> 題</div>
                    </div>

                    <template x-if="quizSet.length===0">
                        <div class="alert alert-warning mt-3">此模式下沒有可出題目（可能沒有錯題或全部被標記為簡單）。</div>
                    </template>

                    <template x-for="(q, idx) in quizSet" :key="q.id">
                        <details class="border rounded-4 p-3 p-md-4 mb-3"
                            :open="!((resultMap[q.id]==='correct' && !unsureMarkAll[q.id]) || resultMap[q.id]==='unanswered')">
                            <summary class="d-flex align-items-center justify-content-between pointer">
                                <div class="q-meta">題號：<span class="mono" x-text="q.id"></span> ｜ <span
                                        x-text="idx+1"></span>/<span x-text="quizSet.length"></span></div>
                                <span class="badge bg-success"
                                    x-show="resultMap[q.id]==='correct' && !unsureMarkAll[q.id]">答對</span>
                                <span class="badge bg-warning text-dark"
                                    x-show="resultMap[q.id]==='unanswered'">未作答</span>
                            </summary>
                            <div class="d-flex align-items-start justify-content-between mt-3">
                                <div>
                                    <div class="fs-5 mt-1" x-html="md(q?.question || '')"></div>
                                </div>
                                <div class="text-end d-flex flex-column align-items-end">
                                    <button class="btn btn-sm btn-outline-secondary mb-2" @click="copyQuestion(q)"
                                        title="複製">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger mb-2" @click="openBug(q.id)"
                                        title="Bug 回報">
                                        <i class="bi bi-bug"></i>
                                    </button>
                                    <span class="badge rounded-pill mb-1" :class="(stats[q.id]?.easy)?'badge-easy':''"
                                        x-text="(stats[q.id]?.easy)?'已標簡單':''"></span>
                                    <template x-if="(stats[q.id]?.wrong||0)+(stats[q.id]?.attempts||0)>0">
                                        <div class="small-muted"><span class="text-danger">錯題</span>/作答：<span
                                                class="text-danger" x-text="stats[q.id]?.wrong||0"></span>/<span
                                                x-text="stats[q.id]?.attempts||0"></span></div>
                                    </template>
                                </div>
                            </div>

                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" :id="'unsure_'+q.id"
                                    x-model="unsureMarkAll[q.id]">
                                <label class="form-check-label" :for="'unsure_'+q.id">這題我不確定</label>
                            </div>

                            <div class="mt-3">
                                <template x-for="opt in q.options" :key="opt.id">
                                    <label class="option-item d-flex gap-2 align-items-start">
                                        <input :type="(q.answer?.length||0)>1 ? 'checkbox':'radio'"
                                            class="form-check-input mt-1" :name="'opt_'+q.id" :value="opt.id"
                                            @change="toggleAnswer(q.id, opt.id, (q.answer?.length||0)>1, $event)"
                                            :checked="(answers[q.id]||new Set()).has(opt.id)" />
                                        <div>
                                            <div class="fw-semibold" x-text="opt.text"></div>
                                            <div class="small text-secondary" x-show="debugMode">id: <span class="mono"
                                                    x-text="opt.id"></span></div>
                                        </div>
                                    </label>
                                </template>
                            </div>

                            <div class="d-flex flex-wrap gap-3 mt-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" :id="'easy_'+q.id"
                                        x-model="easyMarkAll[q.id]">
                                    <label class="form-check-label" :for="'easy_'+q.id">這題很簡單不用再出（需答對才算）</label>
                                </div>
                            </div>

                            <div class="mt-2" x-show="resultMap[q.id]">
                                <div class="alert"
                                    :class="resultMap[q.id]==='correct' ? 'alert-success' : 'alert-danger'">
                                    <div class="fw-semibold" x-text="resultMap[q.id]==='correct'?'答對了！':'答錯囉～'"></div>
                                    <div class="small mt-1">正確答案：<span class="mono" x-text="q.answer.join(', ')"></span>
                                    </div>
                                </div>
                                <details class="mt-2" :open="resultMap[q.id]==='wrong' && $root.expandWrong">
                                    <summary class="fw-semibold pointer"><i class="bi bi-journal-text"></i> 答案與解析
                                    </summary>
                                    <div class="mt-2" x-html="md(q.explanation)"></div>
                                </details>
                            </div>
                        </details>
                    </template>

                    <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-outline-secondary" @click="exitQuiz()"><i class="bi bi-house"></i>
                            回首頁</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @click="submitAll()" x-show="!showScore"><i
                                    class="bi bi-check2-circle"></i>
                                批改全部</button>
                            <button class="btn btn-success" @click="finishAndSummary()"
                                x-show="!showScore && Object.keys(resultMap).length>0"><i class="bi bi-flag"></i>
                                結束並看成績</button>
                            <button class="btn btn-outline-secondary" x-show="showScore" @click="returnToSummary()"><i
                                    class="bi bi-card-list"></i> 回本次成績</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- 成績摘要 -->
        <template x-if="view==='summary'">
            <div class="card card-soft">
                <div class="card-body">
                    <h2 class="h5">本次成績</h2>
                    <div class="row g-3 mt-2">
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">總題數</div>
                                <div class="display-6" x-text="summary.total"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">作答題數</div>
                                <div class="display-6" x-text="summary.total - summary.unanswered"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">未作答</div>
                                <div class="display-6 text-warning" x-text="summary.unanswered"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">答對</div>
                                <div class="display-6 text-success" x-text="summary.correct"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">答錯</div>
                                <div class="display-6 text-danger" x-text="summary.wrong"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="border rounded-4 p-3 text-center">
                                <div class="small-muted">正確率</div>
                                <div class="display-6"
                                    x-text="(summary.total? Math.round(summary.correct/summary.total*100):0)+'%' ">
                                </div>
                            </div>
                        </div>
                    </div>
                    <template x-if="summary.wrongList.length">
                        <div class="mt-4">
                            <h3 class="h6">錯題分析</h3>
                            <ul class="list-group">
                                <template x-for="item in summary.wrongList" :key="item.id">
                                    <li class="list-group-item">
                                        <div class="fw-semibold" x-text="item.question"></div>
                                        <div class="small-muted">題號：<span class="mono" x-text="item.id"></span></div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button class="btn btn-outline-secondary" @click="exitQuiz()"><i class="bi bi-house"></i>
                            回首頁</button>
                        <button class="btn btn-outline-info" @click="viewAllResult()"><i class="bi bi-eye"></i>
                            看解析</button>
                        <button class="btn btn-outline-danger" x-show="summary.wrong>0" @click="reviewWrong()"><i
                                class="bi bi-journal-text"></i> 查看本次錯題</button>
                        <button class="btn btn-primary" @click="startQuiz(mode)"><i class="bi bi-arrow-repeat"></i>
                            同模式再來一輪</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 題庫與詳解檢視 -->
        <template x-if="view==='preview'">
            <div class="card card-soft">
                <div class="card-body">
                    <h2 class="h6 mb-3" x-text="previewTitle"></h2>
                    <template x-if="previewMode==='multi'">
                        <template x-for="(q, idx) in previewSet" :key="q.id">
                            <div class="border rounded-4 p-3 p-md-4 mb-3">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div>
                                        <div class="q-meta">題號：<span class="mono" x-text="q.id"></span> ｜ <span
                                                x-text="idx+1"></span>/<span x-text="previewSet.length"></span></div>
                                        <div class="fs-5 mt-1" x-html="md(q?.question || '')"></div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge rounded-pill me-2" :class="(stats[q.id]?.easy)?'badge-easy':''"
                                            x-text="(stats[q.id]?.easy)?'已標簡單':''"></span>
                                        <template x-if="(stats[q.id]?.wrong||0)+(stats[q.id]?.attempts||0)>0">
                                            <div class="small-muted"><span class="text-danger">錯題</span>/作答：<span
                                                    class="text-danger" x-text="stats[q.id]?.wrong||0"></span>/<span
                                                    x-text="stats[q.id]?.attempts||0"></span></div>
                                        </template>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <template x-for="opt in q.options" :key="opt.id">
                                        <div class="option-item">
                                            <div class="fw-semibold" x-text="opt.text"></div>
                                            <div class="small text-secondary" x-show="debugMode">id: <span class="mono"
                                                    x-text="opt.id"></span></div>
                                        </div>
                                    </template>
                                </div>
                                <details class="mt-2" open>
                                    <summary class="fw-semibold pointer"><i class="bi bi-journal-text"></i> 答案與解析</summary>
                                    <div class="mt-2" x-html="md(q.explanation)"></div>
                                </details>
                            </div>
                        </template>
                    </template>
                    <template x-if="previewMode==='single'">
                        <template x-if="previewSet.length>0">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-outline-secondary" @click="previewIndex--" :disabled="previewIndex<=0">上一題</button>
                                <div class="q-meta">題號：<span class="mono" x-text="currentPreview.id"></span> ｜ <span x-text="previewIndex+1"></span>/<span x-text="previewSet.length"></span></div>
                                <button class="btn btn-outline-secondary" @click="previewIndex++" :disabled="previewIndex>=previewSet.length-1">下一題</button>
                            </div>
                            <div class="border rounded-4 p-3 p-md-4 mb-3">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div>
                                        <div class="fs-5 mt-1" x-html="md(currentPreview?.question || '')"></div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge rounded-pill me-2" :class="(stats[currentPreview.id]?.easy)?'badge-easy':''" x-text="(stats[currentPreview.id]?.easy)?'已標簡單':''"></span>
                                        <template x-if="(stats[currentPreview.id]?.wrong||0)+(stats[currentPreview.id]?.attempts||0)>0">
                                            <div class="small-muted"><span class="text-danger">錯題</span>/作答：<span class="text-danger" x-text="stats[currentPreview.id]?.wrong||0"></span>/<span x-text="stats[currentPreview.id]?.attempts||0"></span></div>
                                        </template>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <template x-for="opt in currentPreview?.options || []" :key="opt.id">
                                        <div class="option-item">
                                            <div class="fw-semibold" x-text="opt.text"></div>
                                            <div class="small text-secondary" x-show="debugMode">id: <span class="mono" x-text="opt.id"></span></div>
                                        </div>
                                    </template>
                                </div>
                                <details class="mt-2" open>
                                    <summary class="fw-semibold pointer"><i class="bi bi-journal-text"></i> 答案與解析</summary>
                                    <div class="mt-2" x-html="md(currentPreview?.explanation || '')"></div>
                                </details>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <button class="btn btn-outline-secondary" @click="previewIndex--" :disabled="previewIndex<=0">上一題</button>
                                <button class="btn btn-outline-secondary" @click="previewIndex++" :disabled="previewIndex>=previewSet.length-1">下一題</button>
                            </div>
                        </template>
                        <template x-if="previewSet.length===0">
                            <div class="alert alert-warning mt-3">此模式下沒有可顯示題目。</div>
                        </template>
                    </template>
<div class="d-flex gap-2 mt-2">
                        <button class="btn btn-outline-secondary" @click="exitPreview()">
                            <i class="bi bi-house"></i> 回首頁
                        </button>
                        <button class="btn btn-outline-success" x-show="summary.total" @click="view='summary'"><i
                                class="bi bi-flag"></i> 回本次成績</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 紀錄管理（可折疊） -->
        <div id="recordPanel" class="collapse mt-4">
            <div class="card card-soft position-relative">
                <!-- <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" @click="openRecordPanel()" title="關閉紀錄管理"><i class="bi bi-x"></i></button> -->
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">統計紀錄檢視</h2>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="onlyWrong"
                                    x-model="filter.onlyWrong">
                                <label class="form-check-label" for="onlyWrong">只看有錯題</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="onlyNotEasy"
                                    x-model="filter.onlyNotEasy">
                                <label class="form-check-label" for="onlyNotEasy">只看已標非簡單</label>
                            </div>
                            <div class="form-check" x-show="easyFeatureOn">
                                <input class="form-check-input" type="checkbox" id="filterDevEasy"
                                    x-model="filter.excludeDevEasy">
                                <label class="form-check-label" for="filterDevEasy">排除開發者標記簡單</label>
                            </div>
                            <input type="text" class="form-control form-control-sm" placeholder="搜尋題號"
                                x-model="recordSearch" style="width:8rem;" />
                            <!-- <button class="btn btn-sm btn-outline-secondary" @click="refreshStatsIds()"><i
                                    class="bi bi-arrow-clockwise"></i> 更新題號</button> -->
                            <!-- <button class="btn btn-sm btn-outline-secondary" @click="saveStatsFile()"><i
                                    class="bi bi-download"></i> 匯出</button> -->
                            <button class="btn btn-sm btn-outline-primary" @click="openQuestionModal()"><i
                                    class="bi bi-journal-text"></i> 題庫</button>
                            <button class="btn btn-sm btn-outline-danger" @click="showWrongWithExp()"><i
                                    class="bi bi-x-circle"></i> 錯題</button>
                            <button class="btn btn-sm btn-outline-success" x-show="easyFeatureOn"
                                @click="exportEasyIds()"><i class="bi bi-download"></i> 匯出簡單題號</button>
                            <button class="btn btn-sm btn-outline-secondary" @click="openRecordPanel()"
                                title="關閉紀錄管理"><i class="bi bi-x"></i> </button>
                        </div>
                    </div>
                    <div class="table-responsive mt-3" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th class="pointer" @click="changeSort('id')">題號
                                        <i class="bi ms-1"
                                            :class="sortKey==='id' ? (sortAsc ? 'bi-caret-up-fill' : 'bi-caret-down-fill') : 'bi-arrow-down-up'"></i>
                                    </th>
                                    <th>作答</th>
                                    <th class="pointer" @click="changeSort('wrong')">錯誤
                                        <i class="bi ms-1"
                                            :class="sortKey==='wrong' ? (sortAsc ? 'bi-caret-up-fill' : 'bi-caret-down-fill') : 'bi-arrow-down-up'"></i>
                                    </th>
                                    <th>正確</th>
                                    <th class="pointer" @click="changeSort('accuracy')">正確率
                                        <i class="bi ms-1"
                                            :class="sortKey==='accuracy' ? (sortAsc ? 'bi-caret-up-fill' : 'bi-caret-down-fill') : 'bi-arrow-down-up'"></i>
                                    </th>
                                    <th class="pointer" @click="changeSort('easy')">簡單
                                        <i class="bi ms-1"
                                            :class="sortKey==='easy' ? (sortAsc ? 'bi-caret-up-fill' : 'bi-caret-down-fill') : 'bi-arrow-down-up'"></i>
                                    </th>
                                    <th>最後作答</th>
                                    <th>動作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="row in statRows" :key="row.id">
                                    <tr>
                                        <td class="mono" x-text="row.id"></td>
                                        <td x-text="row.attempts"></td>
                                        <td x-text="row.wrong"></td>
                                        <td x-text="row.correct"></td>
                                        <td x-text="row.accuracy + '%'"></td>
                                        <td>
                                            <span class="badge rounded-pill" :class="row.easy? 'badge-easy':''"
                                                x-text="row.easy? '是':'否'"></span>
                                        </td>
                                        <td class="mono"
                                            x-text="row.lastSelected?.length? row.lastSelected.join(', '):'-'">
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" @click="toggleEasy(row.id)"><i
                                                        class="bi"
                                                        :class="row.easy? 'bi-x-circle':'bi-bookmark-check' "></i></button>
                                                <button class="btn btn-outline-danger" @click="clearOne(row.id)"><i
                                                        class="bi bi-trash3"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="statRows.length===0">
                                    <td colspan="9" class="text-center text-secondary">尚無紀錄</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bug 回報區 -->
        <div id="bugPanel" class="collapse mt-4">
            <div class="card card-soft position-relative">
                <!-- <button class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2" @click="openBugPanel()" title="關閉 Bug 回報區"><i class="bi bi-x"></i></button> -->
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="h6 mb-0">Bug (假的)回報區</h2>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-secondary" @click="saveBugsFile()"
                                title="下載 bug_reports.json"><i class="bi bi-download"></i> 匯出</button>
                            <label class="btn btn-sm btn-outline-primary mb-0" title="匯入 bug_reports.json">
                                <i class="bi bi-upload"></i> 匯入
                                <input type="file" class="d-none" accept=".json,application/json"
                                    @change="importBugsFile($event)" />
                            </label>
                            <!--
                            <button class="btn btn-sm btn-outline-secondary" @click="importBugsFromDrive()" title="從雲端匯入">
                                <i class="bi bi-cloud-arrow-down"></i> 雲端
                            </button>
                            -->
                            <button class="btn btn-sm btn-outline-secondary" @click="copyAllBugs()"
                                title="可以把問題一鍵複製傳給我哈哈"><i class="bi bi-clipboard"></i> 全部</button>
                            <button class="btn btn-sm btn-outline-secondary" @click="copyBugQids()"
                                title="可以把有問題的題號一鍵複製傳給我哈哈"><i class="bi bi-clipboard"></i> 題號</button>
                            <button class="btn btn-sm btn-outline-danger" @click="clearAllBugs()" title="清空全部"><i
                                    class="bi bi-trash3"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" @click="openBugPanel()"
                                title="關閉 Bug 回報區"><i class="bi bi-x"></i></button>
                        </div>
                    </div>

                    <div class="row g-2 mt-3">
                        <div class="col-12 col-md-2">
                            <input type="text" class="form-control" placeholder="搜尋題號" x-model="bugSearch.qid" />
                        </div>
                        <div class="col-12 col-md">
                            <input type="text" class="form-control" placeholder="搜尋描述" x-model="bugSearch.issue" />
                        </div>
                        <div class="col-6 col-md-2">
                            <select class="form-select" x-model="bugSearch.status">
                                <option value="">全部狀態</option>
                                <template x-for="s in bugStatusOptions" :key="s">
                                    <option :value="s.trim()" x-text="s"></option>
                                </template>
                            </select>
                        </div>
                        <div class="col-6 col-md-2 d-grid">
                            <button class="btn btn-outline-secondary" @click="clearBugSearch();">清除搜尋</button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-primary" @click="openNewBugModal()"><i class="bi bi-plus"></i>
                            新增</button>
                    </div>

                    <div class="table-responsive mt-3">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th style="width:5rem;">題號</th>
                                    <th>描述</th>
                                    <th style="width:10rem;">時間</th>
                                    <th>備註</th>
                                    <th style="width:8rem;">狀態</th>
                                    <th style="width:6rem;">動作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(b, index) in filteredBugs()" :key="index">
                                    <tr>
                                        <td class="mono" x-text="b.qid || '-' "></td>
                                        <td x-text="b.issue || '-' "></td>
                                        <td x-text="b.time ? new Date(b.time).toLocaleDateString() : '-' "></td>
                                        <td x-text="b.note || '-' "></td>
                                        <td>
                                            <div x-data="{ editing:false, val:'' }">
                                                <!-- 顯示模式 -->
                                                <span x-show="!editing"
                                                    @click="val = (b.status ?? '').toString().trim(); editing = true"
                                                    class="cursor-pointer">
                                                    <span x-text="(b.status ?? '').toString().trim() || '-'"></span>
                                                    <i class="bi bi-caret-down-fill ms-1"></i>
                                                </span>

                                                <!-- 編輯模式 -->
                                                <select x-show="editing" class="form-select form-select-sm"
                                                    x-model="val"
                                                    @change="b.status = val; saveBugsToLS(); editing = false"
                                                    @blur="editing = false">
                                                    <template x-for="s in bugStatusOptions" :key="s">
                                                        <option :value="s" x-text="s"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary" @click="openEditBugModal(b)"
                                                    title="修改"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-outline-danger" @click="deleteBug(b)"
                                                    title="刪除"><i class="bi bi-trash3"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="filteredBugs().length===0">
                                    <td colspan="6" class="text-center text-secondary">尚無資料</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 題庫篩選 Modal -->
    <div class="modal fade" id="questionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">題庫選項</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="qExDevEasy" x-model="questionFilter.excludeDevEasy">
                        <label class="form-check-label" for="qExDevEasy">排除開發者覺得簡單的</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="qExUserEasy" x-model="questionFilter.excludeUserEasy">
                        <label class="form-check-label" for="qExUserEasy">排除使用者覺得簡單的</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="qExCorrect" x-model="questionFilter.excludeCorrect">
                        <label class="form-check-label" for="qExCorrect">排除答對的題目</label>
                    </div>
                    <div class="mt-3">
                        <label class="form-label" for="qDisplay">顯示方式</label>
                        <select class="form-select" id="qDisplay" x-model="questionFilter.display">
                            <!-- <option value="single">單題</option> -->
                            <option value="multi">多題</option>
                        </select>
                    </div>
                    <div class="mt-3 text-end">
                        題庫：<span class="fw-semibold" x-text="filteredQuestionCount"></span>題
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @click="enterQuestionBank()">進入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bug 新增/編輯 Modal -->
    <div class="modal fade" id="bugModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="bugModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">題號</label>
                        <input type="text" class="form-control" x-model="editBug.qid" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">問題描述</label>
                        <input type="text" class="form-control" x-model="editBug.issue" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">狀態</label>
                        <select class="form-select" x-model="editBug.status">
                            <template x-for="s in bugStatusOptions" :key="s">
                                <option :value="s" x-text="s"></option>
                            </template>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" x-model="editBug.time" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" x-model="editBug.note"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveBug()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed" style="right:1rem; bottom:1rem; z-index:1000;">
        <div class="d-flex flex-column gap-2">
            <button x-show="showTopBtn" class="btn btn-outline-secondary btn-sm rounded-circle" @click="scrollToTop()"
                title="回到頂端"><i class="bi bi-arrow-up"></i></button>
            <button x-show="showBottomBtn" class="btn btn-outline-secondary btn-sm rounded-circle"
                @click="scrollToBottom()" title="移到底部"><i class="bi bi-arrow-down"></i></button>
        </div>
    </div>

    <!-- Photo viewer -->
     <template x-if="photoViewerOpen && photoFeatureOn">
        <div x-cloak x-transition.opacity
            class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center"
            style="z-index:2000;" @click.self="closePhotoViewer()" @keydown.escape.prevent="closePhotoViewer()">
            <div class="position-relative w-100 h-100 d-flex align-items-center justify-content-center" tabindex="0"
                x-ref="photoViewerPanel" @keydown.left.prevent="prevPhoto()" @keydown.right.prevent="nextPhoto()"
                @touchstart="photoTouchStartX=$event.touches[0].clientX" @touchend="photoHandleSwipe($event)">
                <img :src="currentPhoto" class="img-fluid" style="max-height:90vh; max-width:90vw;" x-show="currentPhoto">
                <div class="text-white" x-show="!currentPhoto">無照片</div>
                <!-- 放在 x-ref="photoViewerPanel" 的那個 div 裡面（四個按鈕旁邊即可） -->
                <div class="position-absolute top-0 start-50 translate-middle-x mt-2 px-2 py-1
                            bg-dark bg-opacity-75 text-white rounded-2 small" x-show="filteredPhotos.length" aria-live="polite">
                    <span x-text="(photoIndex + 1) + '/' + filteredPhotos.length"></span>
                </div>

                <button class="btn btn-light position-absolute top-50 start-0 translate-middle-y ms-2"
                    @click.stop="prevPhoto()"><i class="bi bi-chevron-left"></i></button>
                <button class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-2"
                    @click.stop="nextPhoto()"><i class="bi bi-chevron-right"></i></button>
                <button class="btn btn-light position-absolute top-0 end-0 m-2" @click.stop="closePhotoViewer()"><i
                        class="bi bi-x"></i></button>
                <button class="btn btn-light position-absolute bottom-0 end-0 m-3" @click.stop="toggleFavorite()"
                    :class="{ 'text-danger': isFavorite(currentPhotoName) }"><i
                        :class="isFavorite(currentPhotoName) ? 'bi bi-heart-fill' : 'bi bi-heart'"></i></button>
                <button class="btn btn-light position-absolute bottom-0 start-0 m-3" @click.stop="toggleShowFav()"
                    :class="{ 'text-danger': showFavOnly }"><i class="bi bi-filter"></i> <i class="bi"
                        :class="showFavOnly ? 'bi-heart-fill' : 'bi-heart'"></i></button>
            </div>
        </div>
    </template>

    <script>
        // —— 工具函數 ——
        const md = (text) => window.marked ? window.marked.parse(text) : text;
        const deepClone = (o) => JSON.parse(JSON.stringify(o));
        const fileToText = (file) => new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsText(file, 'utf-8'); });
        const downloadJSON = (obj, filename) => {
            const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        };
        const nowStamp = () => {
            const d = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        };

        const featureCarousel = (items, opts = {}) => ({
            raw: Array.isArray(items) ? items : [],
            items: [],
            current: 0,
            timer: null,
            interval: opts.interval ?? 1000, // 預設每秒換一則
            modalOpen: false,
            modalItem: null,
            modalIndex: 0,
            _prevOverflow: '',

            init() {
                // 只保留 show=true
                this.items = this.raw.filter(x => x?.show);
                if (this.items.length > 1) this.play();

                // 觸控滑動（手機可左右滑）
                let sx = 0;
                this.$el.addEventListener('touchstart', e => { sx = e.changedTouches[0].clientX; }, { passive: true });
                this.$el.addEventListener('touchend', e => {
                    const dx = e.changedTouches[0].clientX - sx;
                    if (Math.abs(dx) > 40) (dx < 0 ? this.next() : this.prev());
                }, { passive: true });
            },

            play() {
                this.pause();
                if (this.items.length > 1) {
                    this.timer = setInterval(() => this.next(), this.interval);
                }
            },
            pause() {
                if (this.timer) { clearInterval(this.timer); this.timer = null; }
            },
            next() { this.current = (this.current + 1) % this.items.length; },
            prev() { this.current = (this.current + this.items.length - 1) % this.items.length; },
            go(i) { this.current = i; this.play(); },
            // methods
            openModal(item, idx) {
                this.modalItem = item;
                this.modalIndex = idx;
                this.modalOpen = true;
                this.pause(); // 停止輪播
                // 鎖背景卷軸
                this._prevOverflow = document.body.style.overflow;
                document.body.style.overflow = 'hidden';
                // 將焦點移到面板（行動裝置也好操作）
                this.$nextTick(() => this.$refs.modalPanel?.focus());
            },
            closeModal() {
                this.modalOpen = false;
                // 還原背景卷軸
                document.body.style.overflow = this._prevOverflow || '';
                // 關閉後恢復輪播（若需要）
                this.play();
            }
        });

        const BUG_STATUS = Object.freeze({
            UNRESOLVED: '未處理',
            IN_PROGRESS: '處理中',
            DONE: '已完成'
        });

        // Google Drive Picker configuration（功能移除）
        /*
        const GOOGLE_API_KEY = 'YOUR_API_KEY';
        const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID';

        function pickFromDrive(onPick, mimeType = 'application/json') {
            if (!window.gapi) { alert('Google API 載入失敗'); return; }
            gapi.load('auth', {
                callback: () => {
                    gapi.auth.authorize({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: ['https://www.googleapis.com/auth/drive.readonly'],
                        immediate: false,
                    }, authResult => {
                        if (authResult && !authResult.error) {
                            const oauthToken = authResult.access_token;
                            gapi.load('picker', {
                                callback: () => {
                                    const view = new google.picker.DocsView()
                                        .setIncludeFolders(false)
                                        .setMimeTypes(mimeType);
                                    const picker = new google.picker.PickerBuilder()
                                        .setOAuthToken(oauthToken)
                                        .setDeveloperKey(GOOGLE_API_KEY)
                                        .addView(view)
                                        .setCallback(data => {
                                            if (data.action === google.picker.Action.PICKED) {
                                                const id = data.docs[0].id;
                                                fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                                                    headers: { 'Authorization': 'Bearer ' + oauthToken }
                                                }).then(r => r.text()).then(onPick);
                                            }
                                        })
                                        .build();
                                    picker.setVisible(true);
                                }
                            });
                        }
                    });
                }
            });
        }
        */

        // —— Alpine Root ——
        function quizApp() {
            return {
                // 狀態
                view: 'home',            // home | quiz | summary | preview | note
                prevView: 'home',
                pageMode: localStorage.getItem('pageMode') || 'all',         // one | all
                mode: 'normal',          // normal | review | wrongOnly | unansweredOnly | noWrongNotEasy
                get modeLabel() { return { normal: '一般測驗', review: '錯題複習（優先）', wrongOnly: '只出錯題', unansweredOnly: '只出未作答題', noWrongNotEasy: '未錯且未標簡單題' }[this.mode] },
                questions: [],
                quizSet: [],
                currentIndex: 0,
                numQuestions: 50,
                shuffle: true,
                excludeEasy: true,
                excludeDevEasy: false,
                expandWrong: true,
                answers: {},            // qid -> Set(optionId)
                resultMap: {},          // qid -> 'correct' | 'wrong'
                easyMarkAll: {},        // 一頁所有題模式下的簡單勾選
                unsureMarkAll: {},      // 一頁所有題模式下的不確定勾選
                easyFeatureOn: true,   // 啟用 easy.json 功能的開關，改這裡
                noteFeatureOn: true,  // 啟用筆記功能的開關，改這裡
                photoFeatureOn: true, // 啟用照片功能的開關，改這裡
                noteHtml: '',
                photoViewerOpen: false,
                photoList: [],
                photoIndex: 0,
                photoFavorites: JSON.parse(localStorage.getItem('photoFavorites') || '[]'),
                showFavOnly: false,
                photoTouchStartX: 0,
                get filteredPhotos() {
                    const fav = new Set(this.photoFavorites);
                    return this.showFavOnly ? this.photoList.filter(p => fav.has(p)) : this.photoList;
                },
                get currentPhotoName() { return this.filteredPhotos[this.photoIndex]; },
                get currentPhoto() { return this.currentPhotoName ? `photo/${this.currentPhotoName}` : ''; },
                easyIds: new Set(),
                featureList: [
                    { date: '2024-08-15', content: '新增筆記（右上角最左邊），gpt 寫的東東，根據照片內容新增中...', show: true },
                    { date: '2024-08-15', content: '新增照片（右上角），人家在 youtube (課太久了截圖內容而已)上複習的教材截圖', show: true },
                    { date: '2024-08-15', content: '題目不會再新增了，根本寫不完還很多重複的QQ', show: true },
                    { date: '2024-08-15', content: '新增我認為太簡單題排除功能（預設開啟）', show: true },
                    { date: '2024-06-01', content: '第二項新功能', show: false },
                    { date: '2024-06-01', content: '第三項新功能', show: false }
                ],// 改這裡
                previewSet: [],
                previewTitle: '',
                previewMode: 'multi',   // multi | single
                previewIndex: 0,
                get currentPreview() { return this.previewSet[this.previewIndex]; },
                questionModal: null,
                questionFilter: { excludeDevEasy: true, excludeUserEasy: true, excludeCorrect: false, display: 'multi' },
                get filteredQuestionCount() {
                    let arr = this.questions.slice();
                    if (this.questionFilter.excludeDevEasy) arr = arr.filter(q => !this.easyIds.has(q.id));
                    if (this.questionFilter.excludeUserEasy) arr = arr.filter(q => !(this.stats[q.id]?.easy));
                    if (this.questionFilter.excludeCorrect) arr = arr.filter(q => !(this.stats[q.id]?.correct));
                    return arr.length;
                },
                showHelp: false,
                debugMode: false,
                version: 'v1.0',
                showTopBtn: false,
                showBottomBtn: false,
                // 計時相關
                perQuestionSec: 120,    // 每題秒數（秒）
                timer: null,
                timeLimitSec: 0,
                remainingSec: 0,
                timerPaused: false,
                get timeText() {
                    const m = Math.floor(this.remainingSec / 60).toString().padStart(2, '0');
                    const s = Math.floor(this.remainingSec % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                },

                // 紀錄（第二個 JSON）
                stats: {},              // qid -> { attempts, wrong, correct, lastSelected:[], easy, unsure, lastAnsweredAt }
                filter: { onlyWrong: true, onlyNotEasy: false, excludeDevEasy: false },
                recordSearch: '',
                sortKey: 'id',
                sortAsc: true,

                // Bug 回報資料
                bugs: [],              // { qid, issue, status, note, time }
                bugStatusOptions: Object.values(BUG_STATUS).map(s => s.trim()),
                editBug: { qid: '', issue: '', status: BUG_STATUS.UNRESOLVED, note: '', time: '' },
                editIndex: -1,
                bugModal: null,
                bugModalTitle: '',
                bugSearch: { qid: '', issue: '', status: '' },

                get statRows() {
                    let rows = Object.values(this.stats).map(s => {
                        const attempts = s.attempts || 0;
                        const correct = s.correct || 0;
                        return { ...s, id: s.id, attempts, correct, accuracy: attempts ? Math.round(correct / attempts * 100) : 0 };
                    });
                    if (this.filter.onlyWrong) rows = rows.filter(r => r.wrong > 0);
                    if (this.filter.onlyNotEasy) rows = rows.filter(r => !r.easy);
                    if (this.filter.excludeDevEasy) rows = rows.filter(r => !this.easyIds.has(r.id));
                    if (this.recordSearch) rows = rows.filter(r => r.id.includes(this.recordSearch.trim()));
                    const asc = this.sortAsc ? 1 : -1;
                    rows.sort((a, b) => {
                        switch (this.sortKey) {
                            case 'wrong':
                                return asc * ((a.wrong || 0) - (b.wrong || 0));
                            case 'easy':
                                return asc * ((a.easy ? 1 : 0) - (b.easy ? 1 : 0));
                            case 'accuracy':
                                return asc * (a.accuracy - b.accuracy);
                            case 'id':
                            default:
                                return asc * a.id.localeCompare(b.id);
                        }
                    });
                    return rows;
                },

                get overallStats() {
                    const qs = this.excludeDevEasy ? this.questions.filter(q => !this.easyIds.has(q.id)) : this.questions;
                    const total = qs.length;
                    let unanswered = 0, wrong = 0, correct = 0, easy = 0;
                    for (const q of qs) {
                        const s = this.stats[q.id] || this.defaultStat(q.id);
                        if ((s.attempts || 0) === 0) unanswered++;
                        wrong += s.wrong || 0;
                        correct += s.correct || 0;
                        if (s.easy) easy++;
                    }
                    const totalAttempts = correct + wrong;
                    const answered = total - unanswered;
                    const accuracy = totalAttempts ? Math.round(correct / totalAttempts * 100) : 0;
                    const notEasy = total - easy;
                    return { total, unanswered, answered, wrong, correct, totalAttempts, accuracy, easy, notEasy };
                },

                get noWrongNotEasyCount() {
                    return this.questions.filter(q => {
                        const s = this.stats[q.id] || {};
                        return (!this.excludeDevEasy || !this.easyIds.has(q.id)) && !s.easy && (s.wrong || 0) === 0;
                    }).length;
                },

                get visibleFeatures() { return this.featureList.filter(f => f.show); },

                async openPhotoViewer() {
                    if (!this.photoFeatureOn) return;
                    if (this.photoList.length === 0) {
                        try {
                            const res = await fetch('photo/photos.json');
                            if (res.ok) {
                                this.photoList = await res.json();
                            } else {
                                console.warn('載入照片清單失敗', res.status);
                            }
                        } catch (err) {
                            console.warn('載入照片清單失敗', err);
                        }
                    }
                    if (this.photoList.length === 0) {
                        alert('找不到照片資料');
                        return;
                    }
                    this.showFavOnly = false;
                    this.photoIndex = 0;
                    this.photoViewerOpen = true;
                    this.$nextTick(() => this.$refs.photoViewerPanel?.focus());
                },
                closePhotoViewer() { this.photoViewerOpen = false; },
                nextPhoto() { if (this.filteredPhotos.length) { this.photoIndex = (this.photoIndex + 1) % this.filteredPhotos.length; } },
                prevPhoto() { if (this.filteredPhotos.length) { this.photoIndex = (this.photoIndex + this.filteredPhotos.length - 1) % this.filteredPhotos.length; } },
                toggleFavorite() {
                    const name = this.currentPhotoName;
                    if (!name) return;
                    const set = new Set(this.photoFavorites);
                    if (set.has(name)) set.delete(name); else set.add(name);
                    this.photoFavorites = Array.from(set);
                    localStorage.setItem('photoFavorites', JSON.stringify(this.photoFavorites));
                },
                isFavorite(name) { return this.photoFavorites.includes(name); },
                toggleShowFav() {
                    this.showFavOnly = !this.showFavOnly;
                    this.photoIndex = 0;
                },
                photoHandleSwipe(e) {
                    const dx = e.changedTouches[0].clientX - this.photoTouchStartX;
                    if (Math.abs(dx) > 40) (dx < 0 ? this.nextPhoto() : this.prevPhoto());
                },

                async init() {
                    document.title = `出題系統 ${this.version}｜Alpine.js`;
                    this.$watch('pageMode', v => localStorage.setItem('pageMode', v));
                    // 從 LocalStorage 載入紀錄
                    this.loadStatsFromLS();
                    this.loadBugsFromLS();
                    if (this.bugs.length === 0) { await this.loadBugsFromFile(); }
                    await this.loadProjectQuestions();
                    this.syncBugsWithQuestions();
                    // 若 LocalStorage 沒有紀錄，才載入預設紀錄檔
                    if (Object.keys(this.stats).length === 0) {
                        await this.loadStatsFromFile();
                        this.syncStatsWithQuestions();
                        this.syncBugsWithQuestions();
                    }
                    if (this.easyFeatureOn) {
                        this.excludeDevEasy = true;
                        this.filter.excludeDevEasy = true;
                        await this.loadEasyList();
                    }
                    this.updateScrollButtons();
                    window.addEventListener('scroll', () => this.updateScrollButtons());
                },

                // 預設載入題庫與紀錄檔
                async loadProjectQuestions() {
                    try {
                        const res = await fetch('question.json', { cache: 'no-store' });
                        if (res.ok) {
                            const arr = await res.json();
                            if (Array.isArray(arr)) {
                                this.questions = arr;
                                this.syncStatsWithQuestions();
                                this.syncBugsWithQuestions();
                                this.numQuestions = Math.min(50, this.questions.length || 50);
                            }
                        }
                    } catch (err) { console.warn('載入預設題庫失敗', err); }
                },
                async loadStatsFromFile() {
                    try {
                        const res = await fetch('quiz_stats.json');
                        if (res.ok) {
                            const obj = await res.json();
                            if (obj && typeof obj === 'object') {
                                this.stats = obj;
                                this.saveStatsToLS();
                            }
                        }
                    } catch (err) { console.warn('載入紀錄檔失敗', err); }
                },
                async loadBugsFromFile() {
                    try {
                        const res = await fetch('bug_reports.json');
                        if (res.ok) {
                            const arr = await res.json();
                            if (Array.isArray(arr)) { this.bugs = arr.map(b => this.normalizeBug(b)); this.saveBugsToLS(); }
                        }
                    } catch (err) { console.warn('載入 bug 檔失敗', err); }
                },
                async loadEasyList() {
                    try {
                        const res = await fetch('easy.json', { cache: 'no-store' });
                        if (res.ok) {
                            const arr = await res.json();
                            if (Array.isArray(arr)) {
                                // 僅載入開發者標記的簡單題號，不異動使用者的作答紀錄
                                this.easyIds = new Set(arr.map(id => String(id)));
                            }
                        }
                    } catch (err) { console.warn('載入 easy.json 失敗', err); }
                },

                // —— 題庫載入 ——
                async loadQuestionsFromFile(e) {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    try {
                        const text = await fileToText(file);
                        const arr = JSON.parse(text);
                        if (!Array.isArray(arr)) throw new Error('題庫 JSON 格式需為陣列');
                        this.questions = arr;
                        this.syncStatsWithQuestions();
                        this.syncBugsWithQuestions();
                        this.numQuestions = Math.min(50, this.questions.length || 50);
                    } catch (err) {
                        alert('載入題庫失敗：' + err.message);
                    }
                },
                /*loadQuestionsFromDrive() {
                    pickFromDrive(text => {
                        try {
                            const arr = JSON.parse(text);
                            if (!Array.isArray(arr)) throw new Error('題庫 JSON 格式需為陣列');
                            this.questions = arr;
                            this.syncStatsWithQuestions();
                            this.syncBugsWithQuestions();
                            this.numQuestions = Math.min(50, this.questions.length || 50);
                        } catch (err) {
                            alert('載入題庫失敗：' + err.message);
                        }
                    });
                },*/
                loadSample() {
                    // 三題示範（與你提供的格式一致）
                    this.questions = [
                        { "id": "0001", "question": "「人工智慧」這個術語首先在哪個歷史性會議上被提出？", "options": [{ "id": 1, "text": "國家測試研討會" }, { "id": 2, "text": "世界電腦高峰會" }, { "id": 3, "text": "達特茅斯會議" }, { "id": 4, "text": "國際機器人聯合會議" }], "answer": [3], "explanation": "<summary>答案與解析</summary>\n\n[正確答案] ✅ 3) 達特茅斯會議（Dartmouth Conference, 1956）\n\n[詳解]  \n1956 年夏天於美國達特茅斯學院舉辦，John McCarthy 等人首次正式使用「Artificial Intelligence」一詞，被視為 AI 的濫觴。\n\n[各選項解析]  \n- 1) 國家測試研討會：沒有與 AI 術語誕生直接相關的經典事件。  \n- 2) 世界電腦高峰會：泛稱，非 1956 年那場歷史關鍵會議。  \n- ✅ 3) 達特茅斯會議：AI 名稱與研究計畫的源頭。  \n- 4) 國際機器人聯合會議：屬機器人領域會議，與術語提出無關。\n\n[補充比較]  \nAI 里程碑：1956 達特茅斯 → 1970s/80s 專家系統 → 2010s 深度學習大爆發。" },
                        { "id": "0002", "question": "哪種 AI 擅長執行「特定任務」，如語音辨識或下棋？", "options": [{ "id": 1, "text": "狹義 AI(Narrow AI)" }, { "id": 2, "text": "通用 AI(General AI)" }, { "id": 3, "text": "超級 AI(Super AI)" }, { "id": 4, "text": "情感 AI(Emotional AI)" }], "answer": [1], "explanation": "<summary>答案與解析</summary>\n\n[正確答案] ✅ 1) 狹義 AI（Narrow AI）\n\n[詳解]  \n針對單一或窄領域任務設計與最佳化的系統，是現今最常見、最落地的 AI 型態。\n\n[各選項解析]  \n- ✅ 1) 狹義 AI：適合單任務（影像分類、ASR、AlphaGo 等）。  \n- 2) 通用 AI（AGI）：目標是跨任務泛化，目前尚未實現。  \n- 3) 超級 AI（ASI）：假想層級，在各面向全面超越人類。  \n- 4) 情感 AI：聚焦情緒辨識與情感互動，非「特定任務型」這種總類。\n\n[補充比較]  \nNarrow（當代實作） → AGI（人類等級泛化） → ASI（超越人類）。" },
                        { "id": "0003", "question": "圖靈提出的測試，用以判斷機器是否表現出與人類無法區分的智慧行為，稱為？", "options": [{ "id": 1, "text": "羅森布拉特感知機" }, { "id": 2, "text": "中文房間論證" }, { "id": 3, "text": "萊特希爾報告" }, { "id": 4, "text": "圖靈測試(Turing Test)" }], "answer": [4], "explanation": "<summary>答案與解析</summary>\n\n[正確答案] ✅ 4) 圖靈測試（Turing Test）\n\n[詳解]  \n若評審僅透過對話無法分辨對象是人或機器，即視為機器通過測試，是一種可操作的智慧判準。\n\n[各選項解析]  \n- 1) 感知機：早期神經網路模型，非測試。  \n- 2) 中文房間：Searle 的哲學反思實驗，用來質疑「是否真正理解」。  \n- 3) 萊特希爾報告：1973 英國對 AI 的評估報告，非測試。  \n- ✅ 4) 圖靈測試：圖靈提出的經典智慧檢驗方式。\n\n[補充比較]  \n圖靈測試重「功能表現」，中文房間重「心智理解」之哲學爭論。" }
                    ];
                    this.syncStatsWithQuestions();
                    this.syncBugsWithQuestions();
                    this.numQuestions = Math.min(50, this.questions.length);
                },
                downloadQuestions() {
                    if (!this.questions?.length) { alert('尚未載入題庫'); return; }
                    downloadJSON(this.questions, `question_${nowStamp()}.json`);
                },

                openQuestionModal() {
                    if (!this.questionModal) {
                        this.questionModal = new bootstrap.Modal(document.getElementById('questionModal'));
                    }
                    this.questionModal.show();
                },
                enterQuestionBank() {
                    if (this.questionModal) this.questionModal.hide();
                    let arr = this.questions.slice();
                    if (this.questionFilter.excludeDevEasy) arr = arr.filter(q => !this.easyIds.has(q.id));
                    if (this.questionFilter.excludeUserEasy) arr = arr.filter(q => !(this.stats[q.id]?.easy));
                    if (this.questionFilter.excludeCorrect) arr = arr.filter(q => !(this.stats[q.id]?.correct));
                    arr.sort((a, b) => a.id.localeCompare(b.id));
                    this.prevView = this.view;
                    this.previewTitle = '題庫';
                    this.previewSet = arr;
                    this.previewMode = this.questionFilter.display;
                    this.previewIndex = 0;
                    this.view = 'preview';
                },
                showAllWithExp() {
                    this.prevView = this.view;
                    this.previewTitle = '所有題目與詳解';
                    this.previewSet = [...this.questions].sort((a, b) => a.id.localeCompare(b.id));
                    this.previewMode = 'multi';
                    this.previewIndex = 0;
                    this.view = 'preview';
                },
                showWrongWithExp() {
                    this.prevView = this.view;
                    const arr = this.questions.filter(q => {
                        const s = this.stats[q.id];
                        return s && s.wrong > 0;
                    }).sort((a, b) => {
                        const sa = this.stats[a.id];
                        const sb = this.stats[b.id];
                        const ra = sa.attempts ? sa.wrong / sa.attempts : 0;
                        const rb = sb.attempts ? sb.wrong / sb.attempts : 0;
                        return rb - ra;
                    });
                    this.previewTitle = '錯題與詳解';
                    this.previewSet = arr;
                    this.previewMode = 'multi';
                    this.previewIndex = 0;
                    this.view = 'preview';
                },
                reviewWrong() {
                    this.prevView = this.view;
                    const wrongIds = this.summary.wrongList.map(item => item.id);
                    const arr = this.quizSet.filter(q => wrongIds.includes(q.id));
                    this.previewTitle = '本次錯題與詳解';
                    this.previewSet = arr;
                    this.previewMode = 'multi';
                    this.previewIndex = 0;
                    this.view = 'preview';
                },
                viewAllResult() {
                    this.pageMode = 'all';
                    this.showScore = true;
                    this.view = 'quiz';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                returnToSummary() {
                    this.showScore = false;
                    this.view = 'summary';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                exitPreview() { this.view = this.prevView || 'home'; },

                // —— 紀錄（第二個 JSON）處理 ——
                defaultStat(id) {
                    return { id, attempts: 0, wrong: 0, correct: 0, lastSelected: [], easy: false, unsure: false, lastAnsweredAt: null };
                },
                syncStatsWithQuestions() {
                    const map = { ...this.stats };
                    for (const q of this.questions) { if (!map[q.id]) map[q.id] = this.defaultStat(q.id); }
                    // 移除已不在題庫中的紀錄（保守：先保留，不移除）
                    this.stats = map;
                    this.saveStatsToLS();
                },
                syncBugsWithQuestions() {
                    const valid = new Set(this.questions.map(q => q.id));
                    this.bugs = this.bugs.filter(b => valid.has(b.qid));
                    this.saveBugsToLS();
                },
                loadStatsFromLS() {
                    try { this.stats = JSON.parse(localStorage.getItem('quizStats') || '{}') || {}; }
                    catch { this.stats = {}; }
                },
                saveStatsToLS() { localStorage.setItem('quizStats', JSON.stringify(this.stats)); },
                saveStatsFile() { downloadJSON(this.stats, 'quiz_stats.json'); },
                exportEasyIds() {
                    const ids = Object.entries(this.stats)
                        .filter(([_, s]) => s.easy)
                        .map(([id]) => id);
                    const blob = new Blob([ids.join(',')], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'easy_export.txt'; a.click();
                    URL.revokeObjectURL(url);
                },
                async importStatsFile(e) {
                    const file = e.target.files?.[0]; if (!file) return;
                    try {
                        const text = await fileToText(file); const incoming = JSON.parse(text) || {};
                        // 合併策略：相同題號的 attempts/wrong/correct 相加；easy 取 OR；lastSelected/lastAnsweredAt 取較新
                        const merged = { ...this.stats };
                        for (const [id, s] of Object.entries(incoming)) {
                            if (!merged[id]) { merged[id] = s; continue; }
                            const cur = merged[id];
                            merged[id] = {
                                id,
                                attempts: (cur.attempts || 0) + (s.attempts || 0),
                                wrong: (cur.wrong || 0) + (s.wrong || 0),
                                correct: (cur.correct || 0) + (s.correct || 0),
                                lastSelected: (s.lastAnsweredAt > cur.lastAnsweredAt ? s.lastSelected : cur.lastSelected) || [],
                                easy: !!(cur.easy || s.easy),
                                unsure: (s.lastAnsweredAt > cur.lastAnsweredAt ? s.unsure : cur.unsure) || false,
                                lastAnsweredAt: Math.max(cur.lastAnsweredAt || 0, s.lastAnsweredAt || 0) || null,
                            };
                        }
                        this.stats = merged; this.saveStatsToLS();
                        alert('匯入完成！');
                    } catch (err) { alert('匯入失敗：' + err.message); }
                    e.target.value = '';
                },
                /*importStatsFromDrive() {
                    pickFromDrive(text => {
                        try {
                            const incoming = JSON.parse(text) || {};
                            const merged = { ...this.stats };
                            for (const [id, s] of Object.entries(incoming)) {
                                if (!merged[id]) { merged[id] = s; continue; }
                                const cur = merged[id];
                                merged[id] = {
                                    id,
                                    attempts: (cur.attempts || 0) + (s.attempts || 0),
                                    wrong: (cur.wrong || 0) + (s.wrong || 0),
                                    correct: (cur.correct || 0) + (s.correct || 0),
                                    lastSelected: (s.lastAnsweredAt > cur.lastAnsweredAt ? s.lastSelected : cur.lastSelected) || [],
                                    easy: !!(cur.easy || s.easy),
                                    unsure: (s.lastAnsweredAt > cur.lastAnsweredAt ? s.unsure : cur.unsure) || false,
                                    lastAnsweredAt: Math.max(cur.lastAnsweredAt || 0, s.lastAnsweredAt || 0) || null,
                                };
                            }
                            this.stats = merged; this.saveStatsToLS();
                            alert('匯入完成！');
                        } catch (err) { alert('匯入失敗：' + err.message); }
                    });
                },*/
                clearAllStats() { if (confirm('清空所有作答紀錄？')) { this.stats = {}; this.saveStatsToLS(); } },
                refreshStatsIds() {
                    const valid = new Set(this.questions.map(q => q.id));
                    for (const id of Object.keys(this.stats)) {
                        if (valid.has(id)) {
                            this.stats[id].id = id;
                        } else {
                            delete this.stats[id];
                        }
                    }
                    for (const q of this.questions) {
                        if (!this.stats[q.id]) this.stats[q.id] = this.defaultStat(q.id);
                    }
                    this.saveStatsToLS();
                },
                changeSort(key) {
                    if (this.sortKey === key) {
                        this.sortAsc = !this.sortAsc;
                    } else {
                        this.sortKey = key;
                        this.sortAsc = true;
                    }
                },
                toggleEasy(id) { if (!this.stats[id]) return; this.stats[id].easy = !this.stats[id].easy; this.saveStatsToLS(); },
                clearOne(id) { if (!this.stats[id]) return; if (confirm(`清除此題（${id}）的紀錄？`)) { this.stats[id] = this.defaultStat(id); this.saveStatsToLS(); } },

                // —— Bug 回報處理 ——
                loadBugsFromLS() {
                    try { this.bugs = (JSON.parse(localStorage.getItem('quizBugs') || '[]') || []).map(b => this.normalizeBug(b)); }
                    catch { this.bugs = []; }
                },
                saveBugsToLS() { localStorage.setItem('quizBugs', JSON.stringify(this.bugs)); },
                openNewBugModal(qid = '') {
                    this.editIndex = -1;
                    this.editBug = {
                        qid: qid || '',
                        issue: '',
                        status: BUG_STATUS.UNRESOLVED,
                        note: '',
                        time: new Date().toISOString().slice(0, 16)
                    };
                    this.bugModalTitle = '新增 Bug';
                    this.showBugModal();
                },
                openEditBugModal(bug) {
                    const idx = this.bugs.indexOf(bug);
                    if (idx === -1) return;
                    this.editIndex = idx;
                    this.editBug = deepClone(bug);
                    this.editBug.time = this.editBug.time ? new Date(this.editBug.time).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16);
                    this.bugModalTitle = '編輯 Bug';
                    this.showBugModal();
                },
                showBugModal() {
                    if (!this.bugModal) { this.bugModal = new bootstrap.Modal(document.getElementById('bugModal')); }
                    this.bugModal.show();
                },
                saveBug() {
                    if (!this.editBug.qid) { alert('請填題號'); return; }
                    if (!this.questions.some(q => q.id === this.editBug.qid)) {
                        alert('題號不存在於題庫');
                        return;
                    }
                    const obj = deepClone(this.editBug);
                    obj.status = this.normalizeStatus(obj.status);
                    obj.time = obj.time ? new Date(obj.time).toISOString() : new Date().toISOString();
                    if (this.editIndex === -1) { this.bugs.push(obj); }
                    else { this.bugs[this.editIndex] = obj; }
                    this.saveBugsToLS();
                    this.syncBugsWithQuestions();
                    this.bugModal.hide();
                },
                deleteBug(bug) {
                    const idx = this.bugs.indexOf(bug);
                    if (idx !== -1) { this.bugs.splice(idx, 1); this.saveBugsToLS(); }
                },
                clearAllBugs() { if (confirm('清空所有 bug 紀錄？')) { this.bugs = []; this.saveBugsToLS(); } },
                copyAllBugs() { navigator.clipboard.writeText(JSON.stringify(this.bugs, null, 2)).then(() => alert('已複製所有 bug')); },
                copyBugQids() {
                    const ids = [...new Set(this.bugs.map(b => b.qid).filter(q => q))];
                    if (ids.length === 0) { alert('沒有題號可複製'); return; }
                    navigator.clipboard.writeText(ids.join(', ')).then(() => alert('已複製所有題號'));
                },
                saveBugsFile() { downloadJSON(this.bugs, 'bug_reports.json'); },
                async importBugsFile(e) {
                    const file = e.target.files?.[0]; if (!file) return;
                    try {
                        const text = await fileToText(file);
                        const arr = JSON.parse(text);
                        if (!Array.isArray(arr)) throw new Error('格式錯誤');
                        this.bugs = arr.map(b => this.normalizeBug(b));
                        this.syncBugsWithQuestions();
                        this.saveBugsToLS();
                        alert('匯入完成！');
                    } catch (err) { alert('匯入失敗：' + err.message); }
                    e.target.value = '';
                },
                /*importBugsFromDrive() {
                    pickFromDrive(text => {
                        try {
                            const arr = JSON.parse(text);
                            if (!Array.isArray(arr)) throw new Error('格式錯誤');
                            this.bugs = arr.map(b => this.normalizeBug(b));
                            this.syncBugsWithQuestions();
                            this.saveBugsToLS();
                            alert('匯入完成！');
                        } catch (err) { alert('匯入失敗：' + err.message); }
                    });
                },*/
                openNote() {
                    fetch('note.md')
                        .then(r => r.text())
                        .then(md => {
                            this.noteHtml = marked.parse(md);
                            this.view = 'note';
                        })
                        .catch(() => alert('筆記載入失敗'));
                },
                openQbankPanel() {
                    const panel = document.getElementById('qbankPanel');
                    if (panel) {
                        const bs = bootstrap.Collapse.getOrCreateInstance(panel, { toggle: false });
                        const willShow = !panel.classList.contains('show');
                        if (willShow) {
                            panel.addEventListener('shown.bs.collapse', () => {
                                panel.scrollIntoView({ behavior: 'smooth' });
                            }, { once: true });
                        }
                        bs.toggle();
                    }
                },
                openRecordPanel() {
                    this.filter.onlyWrong = true;
                    const panel = document.getElementById('recordPanel');
                    if (panel) {
                        const bs = bootstrap.Collapse.getOrCreateInstance(panel, { toggle: false });
                        const willShow = !panel.classList.contains('show');
                        if (willShow) {
                            panel.addEventListener('shown.bs.collapse', () => {
                                panel.scrollIntoView({ behavior: 'smooth' });
                            }, { once: true });
                        }
                        bs.toggle();
                    }
                },
                openBugPanel() {
                    this.bugSearch = { qid: '', issue: '', status: '' };
                    const panel = document.getElementById('bugPanel');
                    if (panel) {
                        const bs = bootstrap.Collapse.getOrCreateInstance(panel, { toggle: false });
                        const willShow = !panel.classList.contains('show');
                        if (willShow) {
                            panel.addEventListener('shown.bs.collapse', () => {
                                panel.scrollIntoView({ behavior: 'smooth' });
                            }, { once: true });
                        }
                        bs.toggle();
                    }
                },
                closeAllPanels() {
                    this.showHelp = false;
                    ['qbankPanel', 'recordPanel', 'bugPanel'].forEach(id => {
                        const p = document.getElementById(id);
                        if (p) {
                            const bs = bootstrap.Collapse.getOrCreateInstance(p, { toggle: false });
                            bs.hide();
                        }
                    });
                },
                openBug(qid) {
                    this.openNewBugModal(qid);
                },
                filteredBugs() {
                    const norm = v => (v ?? '').toString().trim();
                    const q = norm(this.bugSearch.qid);
                    const i = norm(this.bugSearch.issue);
                    const s = norm(this.bugSearch.status); // 中文 or 空字串

                    return this.bugs.filter(b => {
                        const qMatch = !q || norm(b.qid).includes(q);
                        const iMatch = !i || norm(b.issue).includes(i);
                        const sMatch = !s || norm(b.status) === s;
                        return qMatch && iMatch && sMatch;
                    });
                },
                clearBugSearch() { this.bugSearch = { qid: '', issue: '', status: '' }; },

                normalizeStatus(s) {
                    if (s === '已處理') return BUG_STATUS.DONE;
                    return Object.values(BUG_STATUS).includes(s) ? s : BUG_STATUS.UNRESOLVED;
                },

                normalizeBug(b) {
                    return {
                        qid: b.qid || '',
                        issue: b.issue || '',
                        status: this.normalizeStatus(b.status),
                        note: b.note || '',
                        time: b.time ? new Date(b.time).toISOString() : new Date().toISOString()
                    };
                },

                // —— 建立出題清單 ——
                startQuiz(mode) {
                    this.closeAllPanels();
                    this.mode = mode; this.view = 'quiz'; this.currentIndex = 0; this.answers = {}; this.resultMap = {}; this.easyMarkAll = {}; this.unsureMarkAll = {};
                    this.showScore = false;
                    this.summary = { total: 0, correct: 0, wrong: 0, unanswered: 0, wrongList: [] };
                    clearInterval(this.timer);
                    const all = this.questions.slice();
                    let pool;
                    if (mode === 'noWrongNotEasy') {
                        pool = all.filter(q => {
                            const s = this.stats[q.id] || {};
                            return (!this.excludeDevEasy || !this.easyIds.has(q.id)) && !s.easy && (s.wrong || 0) === 0;
                        });
                    } else {
                        // 過濾：排除已標簡單及開發者標示簡單
                        pool = all.filter(q => (!this.excludeDevEasy || !this.easyIds.has(q.id)) && (!this.excludeEasy || !(this.stats[q.id]?.easy)));

                        if (mode === 'wrongOnly') {
                            pool = pool.filter(q => (this.stats[q.id]?.wrong || 0) > 0);
                        }

                        if (mode === 'unansweredOnly') {
                            pool = pool.filter(q => (this.stats[q.id]?.attempts || 0) === 0);
                        }
                    }

                    // 未作答優先，其次依錯誤率排序
                    pool.sort((a, b) => {
                        const sa = this.stats[a.id] || {}, sb = this.stats[b.id] || {};
                        const aa = sa.attempts || 0, ba = sb.attempts || 0;
                        if (aa === 0 && ba > 0) return -1;
                        if (ba === 0 && aa > 0) return 1;
                        const ar = (aa ? sa.wrong / aa : 0), br = (ba ? sb.wrong / ba : 0);
                        if (br !== ar) return br - ar; // 高錯率優先
                        return ba - aa; // 嘗試多者優先
                    });

                    if (this.shuffle) {
                        // 隨機洗牌
                        for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[pool[i], pool[j]] = [pool[j], pool[i]]; }
                    }

                    this.quizSet = pool.slice(0, Math.min(this.numQuestions, pool.length));
                    // 初始化已選答案容器
                    this.quizSet.forEach(q => { this.answers[q.id] = new Set(); this.easyMarkAll[q.id] = false; this.unsureMarkAll[q.id] = false; });
                    // 計時：依總題數計算總秒數
                    const totalSec = Math.min(75 * 60, this.quizSet.length * this.perQuestionSec);
                    this.timeLimitSec = totalSec;
                    this.startTimer(true);
                },

                startTimer(reset = false) {
                    if (reset) this.remainingSec = this.timeLimitSec;
                    clearInterval(this.timer);
                    this.timerPaused = false;
                    if (this.remainingSec <= 0) { this.finishAndSummary(); return; }
                    this.timer = setInterval(() => {
                        if (this.remainingSec > 0) {
                            this.remainingSec--;
                        } else {
                            clearInterval(this.timer);
                            this.finishAndSummary();
                        }
                    }, 1000);
                },

                pauseTimer() {
                    clearInterval(this.timer);
                    this.timerPaused = true;
                },

                resumeTimer() {
                    this.startTimer();
                },

                // —— 一頁一題：導覽與收尾 ——
                prev() {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                next() {
                    if (this.currentIndex < this.quizSet.length - 1) {
                        this.currentIndex++;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                finishAndSummary() {
                    clearInterval(this.timer);
                    // 批改所有作答
                    for (const q of this.quizSet) {
                        const picked = Array.from(this.answers[q.id] || []);
                        if (picked.length === 0) { this.resultMap[q.id] = 'unanswered'; continue; }
                        const ok = this.isCorrectAnswer(q.answer, picked);
                        if (this.resultMap[q.id]) continue;
                        this.applyResult(q.id, ok, picked, this.easyMarkAll[q.id], this.unsureMarkAll[q.id]);
                        this.resultMap[q.id] = ok ? 'correct' : 'wrong';
                    }
                    // 以本次出題集為基準計算統計
                    const total = this.quizSet.length;
                    const answeredIds = Object.keys(this.resultMap).filter(id => this.resultMap[id] !== 'unanswered');
                    const correct = answeredIds.filter(id => this.resultMap[id] === 'correct').length;
                    const wrongIds = answeredIds.filter(id => this.resultMap[id] === 'wrong');
                    const wrong = wrongIds.length;
                    const unanswered = total - answeredIds.length;
                    const wrongList = wrongIds.map(id => {
                        const q = this.quizSet.find(q => q.id === id);
                        return q ? { id: q.id, question: q.question } : { id, question: '' };
                    });
                    this.summary = { total, correct, wrong, unanswered, wrongList };
                    this.saveStatsToLS();
                    this.view = 'summary';
                },

                exitQuiz() {
                    clearInterval(this.timer);
                    this.view = 'home';
                    this.showScore = false;
                },

                scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },
                scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); },
                updateScrollButtons() {
                    this.showTopBtn = window.scrollY > 0;
                    this.showBottomBtn = window.innerHeight + window.scrollY < document.documentElement.scrollHeight;
                },

                // —— 一頁所有題：批改 ——
                toggleAnswer(qid, optId, isMulti, ev) {
                    if (!this.answers[qid]) this.answers[qid] = new Set();
                    const set = this.answers[qid];
                    if (isMulti) { ev.target.checked ? set.add(optId) : set.delete(optId); }
                    else { this.answers[qid] = new Set([optId]); }
                },
                copyQuestion(q) {
                    if (!q) return;
                    const opts = (q.options || []).map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt.text}`).join('\n');
                    const text = `題號：${q.id}\n${q.question}\n${opts}`;
                    navigator.clipboard.writeText(text).then(() => alert('已複製題目與選項'));
                },
                submitAll() {
                    clearInterval(this.timer);
                    let any = false;
                    for (const q of this.quizSet) {
                        const picked = Array.from(this.answers[q.id] || []);
                        if (picked.length === 0) { this.resultMap[q.id] = 'unanswered'; continue; }
                        any = true;
                        const ok = this.isCorrectAnswer(q.answer, picked);
                        // 更新紀錄
                        this.applyResult(q.id, ok, picked, this.easyMarkAll[q.id], this.unsureMarkAll[q.id]);
                        this.resultMap[q.id] = ok ? 'correct' : 'wrong';
                    }
                    if (!any) { alert('尚未作答任何題目'); return; }
                    const total = this.quizSet.length;
                    const answeredIds = Object.keys(this.resultMap).filter(id => this.resultMap[id] !== 'unanswered');
                    const correct = answeredIds.filter(id => this.resultMap[id] === 'correct').length;
                    const wrongIds = answeredIds.filter(id => this.resultMap[id] === 'wrong');
                    const wrong = wrongIds.length;
                    const unanswered = total - answeredIds.length;
                    const wrongList = wrongIds.map(id => {
                        const q = this.quizSet.find(q => q.id === id);
                        return q ? { id: q.id, question: q.question } : { id, question: '' };
                    });
                    this.summary = { total, correct, wrong, unanswered, wrongList };
                    this.showScore = true;
                    this.saveStatsToLS();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                // —— 共用：正誤判定與紀錄套用 ——
                isCorrectAnswer(ansArr, picked) {
                    const a = new Set((ansArr || []).map(Number));
                    const b = new Set((picked || []).map(Number));
                    if (a.size !== b.size) return false;
                    for (const v of a) { if (!b.has(v)) return false; }
                    return true;
                },
                applyResult(qid, ok, picked, markEasy, markUnsure) {
                    if (!this.stats[qid]) this.stats[qid] = this.defaultStat(qid);
                    const s = this.stats[qid];
                    s.attempts = (s.attempts || 0) + 1;
                    s.wrong = (s.wrong || 0) + (ok ? 0 : 1);
                    s.correct = (s.correct || 0) + (ok ? 1 : 0);
                    s.lastSelected = [...picked];
                    s.lastAnsweredAt = Date.now();
                    // 簡單標記：僅在答對且有勾選時才成立
                    if (ok && markEasy) s.easy = true;
                    // 不確定標記：只要勾選就記錄
                    s.unsure = !!markUnsure;
                },

                // —— 摘要資料容器 ——
                summary: { total: 0, correct: 0, wrong: 0, unanswered: 0, wrongList: [] },
                showScore: false,
            }
        }

        // —— 單題元件 VM ——
        function questionVM() {
            return {
                q: null,
                stat: null,
                isMulti: false,
                selected: new Set(),
                hasResult: false,
                isCorrect: false,
                expOpen: false,
                markEasy: false,
                markUnsure: false,
                root: null,
                qInit() {
                    // 取得根元件資料
                    this.root = Alpine.$data(this.$root);
                    // 監聽根元件的索引與題組變化以載入對應題目
                    this.$watch('root.currentIndex', i => {
                        this.loadQuestion(this.root.quizSet[i]);
                    });
                    this.$watch('root.quizSet', () => {
                        this.loadQuestion(this.root.quizSet[this.root.currentIndex]);
                    });
                    // 監聽「這題我不確定」變化並寫入紀錄
                    this.$watch('markUnsure', v => {
                        if (!this.q) return;
                        this.root.unsureMarkAll[this.q.id] = v;
                        if (!this.root.stats[this.q.id]) {
                            this.root.stats[this.q.id] = this.root.defaultStat(this.q.id);
                        }
                        this.root.stats[this.q.id].unsure = v;
                        this.root.saveStatsToLS();
                    });
                    // 監聽「這題很簡單」變化並寫入紀錄（需已答對才算）
                    this.$watch('markEasy', v => {
                        if (!this.q) return;
                        this.root.easyMarkAll[this.q.id] = v;
                        if (!this.root.stats[this.q.id]) {
                            this.root.stats[this.q.id] = this.root.defaultStat(this.q.id);
                        }
                        const s = this.root.stats[this.q.id];
                        if (!v) {
                            s.easy = false;
                            this.root.saveStatsToLS();
                            return;
                        }
                        if (this.hasResult && this.isCorrect) {
                            s.easy = true;
                            this.root.saveStatsToLS();
                        }
                    });
                    this.loadQuestion(this.root.quizSet[this.root.currentIndex]);
                },
                loadQuestion(q) {
                    if (!q) return;
                    this.q = q;
                    const root = this.root;
                    this.stat = root.stats[q.id] || root.defaultStat(q.id);
                    this.isMulti = (q.answer?.length || 0) > 1;
                    this.selected = new Set(root.answers[q.id] || []);
                    this.hasResult = false;
                    this.isCorrect = false;
                    this.expOpen = false;
                    this.markEasy = (root.easyMarkAll[q.id] !== undefined) ? root.easyMarkAll[q.id] : !!this.stat.easy;
                    this.markUnsure = (root.unsureMarkAll[q.id] !== undefined) ? root.unsureMarkAll[q.id] : !!this.stat.unsure;
                    root.easyMarkAll[q.id] = this.markEasy;
                    root.unsureMarkAll[q.id] = this.markUnsure;
                },
                optionClass(id) {
                    if (!this.hasResult) return '';
                    const correctSet = new Set((this.q.answer || []).map(Number));
                    const picked = this.selected.has(id);
                    if (correctSet.has(id) && picked) return 'option-correct';
                    if (!correctSet.has(id) && picked) return 'option-wrong';
                    return '';
                },
                toggle(id, ev) {
                    if (this.isMulti) { ev.target.checked ? this.selected.add(id) : this.selected.delete(id); }
                    else { this.selected = new Set([id]); }
                    // 同步回外層
                    this.root.answers[this.q.id] = new Set(this.selected);
                },
                resetCurrent() {
                    this.selected.clear();
                    this.hasResult = false;
                    this.isCorrect = false;
                    this.expOpen = false;
                    this.markEasy = false;
                    this.markUnsure = false;
                    this.root.answers[this.q.id] = new Set();
                    this.root.easyMarkAll[this.q.id] = false;
                    this.root.unsureMarkAll[this.q.id] = false;
                },
                submitOne() {
                    const picked = Array.from(this.selected);
                    if (picked.length === 0) { alert('請先選擇答案'); return; }
                    const ok = this.root.isCorrectAnswer(this.q.answer, picked);
                    this.hasResult = true; this.isCorrect = ok;
                    // 回寫紀錄
                    if (!this.root.stats[this.q.id]) this.root.stats[this.q.id] = this.root.defaultStat(this.q.id);
                    const s = this.root.stats[this.q.id];
                    s.attempts = (s.attempts || 0) + 1;
                    s.wrong = (s.wrong || 0) + (ok ? 0 : 1);
                    s.correct = (s.correct || 0) + (ok ? 1 : 0);
                    s.lastSelected = [...picked];
                    s.lastAnsweredAt = Date.now();
                    if (ok && this.markEasy) s.easy = true; // 需答對才成立
                    s.unsure = !!this.markUnsure;
                    this.root.resultMap[this.q.id] = ok ? 'correct' : 'wrong';
                    this.root.saveStatsToLS();
                    if (!ok && this.root.expandWrong) this.expOpen = true;
                },
                onSubmitFromParent(e) { if (e.detail?.id === this.q.id) { this.submitOne(); } },
            }
        }
    </script>

    <!-- Bootstrap JS（僅供折疊/元件） -->
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>